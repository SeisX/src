%Exact velocity

mat = {{c11,c12,c13,0,0,0},{c12,c22,c23,0,0,0},{c13,c23,c33,0,0,0},{0,0,0,c44,0,0},{0,0,0,0,c55,0},{0,0,0,0,0,c66}};
matn = {{n1,0,0,0,n3,n2},{0,n2,0,n3,0,n1},{0,0,n3,n2,n1,0}} ;
chris = matn.mat.Transpose[matn];
chrisp = chris /.{n1->p1,n2->p2,n3->p3};
det = Det[chrisp-IdentityMatrix[3]];
%Hamiltonian to derive coefficients
F = det;(*Hamiltonian*)
p3sqf=p3sq/.Solve[0==F/.p3->Sqrt[p3sq],p3sq][[1]]; (*Orthorhombic qP*)

p3sqf1=p3sqf/.{c11->3.512016`,c22->3.875328`,c33->3.0276`,c44->0.1669390243902439`,c55->0.1521`,c66->0.27378`,c12->3.298434960000476`,c23->2.9819605693294067`,c13->2.8709922298203208`};
p3sqf2 = p3sqf/.{c11->4.51632`,c22->4.817408`,c33->3.7636`,c44->0.64896`,c55->0.6084`,c66->0.97344`,c12->2.995458418291907`,c23->2.3894757760926923`,c13->2.6577570205977543`};
p3sqf3=p3sqf/.{c11->8.7725`,c22->9.68`,c33->7.5625`,c44->1.4896636363636364`,c55->2.3409`,c66->3.27726`,c12->2.3050157470049792`,c23->5.297420162994092`,c13->3.1749113238217275`};

dxdσ = D[F,p1]//Simplify;
dydσ = D[F,p2]//Simplify;
dzdσ = D[F,p3]//Simplify;

depth1 = 0.25; depth2 = 0.45;depth3=0.3; (*depth in km*)
depth = depth1 + depth2+depth3;
dx1 =Δd1 dxdσ /dzdσ /.{p3->Sqrt[p3sqf1]}/.{c11->3.512016`,c22->3.875328`,c33->3.0276`,c44->0.1669390243902439`,c55->0.1521`,c66->0.27378`,c12->3.298434960000476`,c23->2.9819605693294067`,c13->2.8709922298203208`};
dx2 =Δd2 dxdσ /dzdσ /.{p3->Sqrt[p3sqf2]}/.{c11->4.51632`,c22->4.817408`,c33->3.7636`,c44->0.64896`,c55->0.6084`,c66->0.97344`,c12->2.995458418291907`,c23->2.3894757760926923`,c13->2.6577570205977543`};
dx3 =Δd3 dxdσ /dzdσ /.{p3->Sqrt[p3sqf3]}/.{c11->8.7725`,c22->9.68`,c33->7.5625`,c44->1.4896636363636364`,c55->2.3409`,c66->3.27726`,c12->2.3050157470049792`,c23->5.297420162994092`,c13->3.1749113238217275`};
dy1 = Δd1 dydσ /dzdσ /.{p3->Sqrt[p3sqf1]}/.{c11->3.512016`,c22->3.875328`,c33->3.0276`,c44->0.1669390243902439`,c55->0.1521`,c66->0.27378`,c12->3.298434960000476`,c23->2.9819605693294067`,c13->2.8709922298203208`};
dy2 = Δd2 dydσ /dzdσ /.{p3->Sqrt[p3sqf2]}/.{c11->4.51632`,c22->4.817408`,c33->3.7636`,c44->0.64896`,c55->0.6084`,c66->0.97344`,c12->2.995458418291907`,c23->2.3894757760926923`,c13->2.6577570205977543`};
dy3 = Δd3 dydσ /dzdσ /.{p3->Sqrt[p3sqf3]}/.{c11->8.7725`,c22->9.68`,c33->7.5625`,c44->1.4896636363636364`,c55->2.3409`,c66->3.27726`,c12->2.3050157470049792`,c23->5.297420162994092`,c13->3.1749113238217275`};
dt1 =Δd1 ((p1 dxdσ+p2 dydσ)/dzdσ +p3)/.{p3->Sqrt[p3sqf1]}/.{c11->3.512016`,c22->3.875328`,c33->3.0276`,c44->0.1669390243902439`,c55->0.1521`,c66->0.27378`,c12->3.298434960000476`,c23->2.9819605693294067`,c13->2.8709922298203208`};
dt2 =Δd2 ((p1 dxdσ+p2 dydσ)/dzdσ +p3)/.{p3->Sqrt[p3sqf2]}/.{c11->4.51632`,c22->4.817408`,c33->3.7636`,c44->0.64896`,c55->0.6084`,c66->0.97344`,c12->2.995458418291907`,c23->2.3894757760926923`,c13->2.6577570205977543`};
dt3 =Δd3 ((p1 dxdσ+p2 dydσ)/dzdσ +p3)/.{p3->Sqrt[p3sqf3]}/.{c11->8.7725`,c22->9.68`,c33->7.5625`,c44->1.4896636363636364`,c55->2.3409`,c66->3.27726`,c12->2.3050157470049792`,c23->5.297420162994092`,c13->3.1749113238217275`};
dx = (dx1 + dx2 + dx3)/.{Δd1->depth1,Δd2->depth2,Δd3->depth3};
dy = (dy1 + dy2 + dy3)/.{Δd1->depth1,Δd2->depth2,Δd3->depth3};
dt = (dt1 + dt2 + dt3)/.{Δd1->depth1,Δd2->depth2,Δd3->depth3};


%Exact (Different R)
c = Cos[theta];
s = Sin[theta];
exact = (-0.00682305+8.78897*10^-19 I) x1^4-(0.0162965+4.64623*10^-18 I) x1^2 x2^2-(0.00945721-1.61273*10^-18 I) x2^4/.{x1->c,x2->s };


%Al-Dajaini (1998)
δ2L1=((c13+c55)^2-(c33-c55)^2)/(2*c33*(c33-c55))/.{c11->3.512016`,c22->3.875328`,c33->3.0276`,c44->0.1669390243902439`,c55->0.1521`,c66->0.27378`,c12->3.298434960000476`,c23->2.9819605693294067`,c13->2.8709922298203208`};
δ1L1=((c23+c44)^2-(c33-c44)^2)/(2*c33*(c33-c44))/.{c11->3.512016`,c22->3.875328`,c33->3.0276`,c44->0.1669390243902439`,c55->0.1521`,c66->0.27378`,c12->3.298434960000476`,c23->2.9819605693294067`,c13->2.8709922298203208`};

δ2L2=((c13+c55)^2-(c33-c55)^2)/(2*c33*(c33-c55))/.{c11->4.51632`,c22->4.817408`,c33->3.7636`,c44->0.64896`,c55->0.6084`,c66->0.97344`,c12->2.995458418291907`,c23->2.3894757760926923`,c13->2.6577570205977543`};
δ1L2=((c23+c44)^2-(c33-c44)^2)/(2*c33*(c33-c44))/.{c11->4.51632`,c22->4.817408`,c33->3.7636`,c44->0.64896`,c55->0.6084`,c66->0.97344`,c12->2.995458418291907`,c23->2.3894757760926923`,c13->2.6577570205977543`};

δ2L3=((c13+c55)^2-(c33-c55)^2)/(2*c33*(c33-c55))/.{c11->8.7725`,c22->9.68`,c33->7.5625`,c44->1.4896636363636364`,c55->2.3409`,c66->3.27726`,c12->2.3050157470049792`,c23->5.297420162994092`,c13->3.1749113238217275`};
δ1L3=((c23+c44)^2-(c33-c44)^2)/(2*c33*(c33-c44))/.{c11->8.7725`,c22->9.68`,c33->7.5625`,c44->1.4896636363636364`,c55->2.3409`,c66->3.27726`,c12->2.3050157470049792`,c23->5.297420162994092`,c13->3.1749113238217275`};

η2L1 = (c11(c33-c55))/(2c13(c13+2c55)+2c33 c55)-1/2/.{c11->3.512016`,c22->3.875328`,c33->3.0276`,c44->0.1669390243902439`,c55->0.1521`,c66->0.27378`,c12->3.298434960000476`,c23->2.9819605693294067`,c13->2.8709922298203208`};
η1L1 = (c22(c33-c44))/(2c23(c23+2c44)+2c33 c44)-1/2/.{c11->3.512016`,c22->3.875328`,c33->3.0276`,c44->0.1669390243902439`,c55->0.1521`,c66->0.27378`,c12->3.298434960000476`,c23->2.9819605693294067`,c13->2.8709922298203208`};
η3L1 =(c22(c11-c66))/(2c12(c12+2c66)+2c11 c66)-1/2/.{c11->3.512016`,c22->3.875328`,c33->3.0276`,c44->0.1669390243902439`,c55->0.1521`,c66->0.27378`,c12->3.298434960000476`,c23->2.9819605693294067`,c13->2.8709922298203208`};
ηxyL1 = Sqrt[(1+2η1L1)(1+2η2L1)/(1+2η3L1)]-1 ;

η2L2 = (c11(c33-c55))/(2c13(c13+2c55)+2c33 c55)-1/2/.{c11->4.51632`,c22->4.817408`,c33->3.7636`,c44->0.64896`,c55->0.6084`,c66->0.97344`,c12->2.995458418291907`,c23->2.3894757760926923`,c13->2.6577570205977543`};
η1L2 = (c22(c33-c44))/(2c23(c23+2c44)+2c33 c44)-1/2/.{c11->4.51632`,c22->4.817408`,c33->3.7636`,c44->0.64896`,c55->0.6084`,c66->0.97344`,c12->2.995458418291907`,c23->2.3894757760926923`,c13->2.6577570205977543`};
η3L2 =(c22(c11-c66))/(2c12(c12+2c66)+2c11 c66)-1/2/.{c11->4.51632`,c22->4.817408`,c33->3.7636`,c44->0.64896`,c55->0.6084`,c66->0.97344`,c12->2.995458418291907`,c23->2.3894757760926923`,c13->2.6577570205977543`};
ηxyL2 = Sqrt[(1+2η1L2)(1+2η2L2)/(1+2η3L2)]-1 ;

η2L3 = (c11(c33-c55))/(2c13(c13+2c55)+2c33 c55)-1/2/.{c11->8.7725`,c22->9.68`,c33->7.5625`,c44->1.4896636363636364`,c55->2.3409`,c66->3.27726`,c12->2.3050157470049792`,c23->5.297420162994092`,c13->3.1749113238217275`};
η1L3 = (c22(c33-c44))/(2c23(c23+2c44)+2c33 c44)-1/2/.{c11->8.7725`,c22->9.68`,c33->7.5625`,c44->1.4896636363636364`,c55->2.3409`,c66->3.27726`,c12->2.3050157470049792`,c23->5.297420162994092`,c13->3.1749113238217275`};
η3L3 =(c22(c11-c66))/(2c12(c12+2c66)+2c11 c66)-1/2/.{c11->8.7725`,c22->9.68`,c33->7.5625`,c44->1.4896636363636364`,c55->2.3409`,c66->3.27726`,c12->2.3050157470049792`,c23->5.297420162994092`,c13->3.1749113238217275`};
ηxyL3 = Sqrt[(1+2η1L3)(1+2η2L3)/(1+2η3L3)]-1 ;

vert=({2dt1,2dt2,2dt3})/.{Δd1->depth1,Δd2->depth2,Δd3->depth3}/.{p1->0,p2->0};
vertt= (2dt)/.{Δd1->depth1,Δd2->depth2,Δd3->depth3}/.{p1->0,p2->0};
vertn= vert/vertt;

A2L1 = (1/(c33(1+2δ2L1)))c^2 +(1/(c33(1+2δ1L1)))s^2/.c33->3.0276;
A2L2 =(1/(c33(1+2δ2L2)))c^2 +(1/(c33(1+2δ1L2)))s^2/.c33->3.7636;
A2L3 =(1/(c33(1+2δ2L3)))c^2 +1/(c33(1+2δ1L3))s^2/.c33->7.5625;
A4L1 =  (((-2η2L1) (1/(c33(1+2δ2L1)))^2c^4+  (-2ηxyL1) (1/(c33(1+2δ2L1))) (1/(c33(1+2δ1L1)))c^2 s^2 +  (-2η1L1 ) (1/(c33(1+2δ1L1)))^2s^4)/t0^2 )/.c33->3.0276/.t0->2 (depth1/Sqrt[3.0276]);
A4L2 =  (((-2η2L2) (1/(c33(1+2δ2L2)))^2c^4+  (-2ηxyL2) (1/(c33(1+2δ2L2))) (1/(c33(1+2δ1L2)))c^2 s^2 +  (-2η1L2 ) (1/(c33(1+2δ1L2)))^2s^4)/t0^2 )/.c33->3.7636/.t0->2 (depth2/Sqrt[3.7636]);
A4L3 =  (((-2η2L3) (1/(c33(1+2δ2L3)))^2c^4+  (-2ηxyL3) (1/(c33(1+2δ2L3))) (1/(c33(1+2δ1L3)))c^2 s^2 +  (-2η1L3 ) (1/(c33(1+2δ1L3)))^2s^4)/t0^2 )/.c33->7.5625/.t0->2 (depth3/Sqrt[7.5625]);
Q4 =((vert.{1/A2L1,1/A2L2,1/A2L3})^2-vertt (vert.{1/A2L1^2,1/A2L2^2,1/A2L3^2}))/(4 (vert.{1/A2L1,1/A2L2,1/A2L3})^4)+(vertt((vert^3).{A4L1/ A2L1^4,A4L2 /A2L2^4,A4L3/ A2L3^4}))/(vert.{1/A2L1,1/A2L2,1/A2L3})^4;

alplot = ParametricPlot[{theta*180/Pi,100Abs[Q4/exact-1]},{theta,0,Pi/2},PlotRange->{All,All},PlotStyle->{Thick,Dashing[Small],RGBColor[0,0.8,0.2]},AspectRatio->0.5]



%Xu et al. (2005)
A4avL1 =  -2( (η2L1)c^2-  (η3L1)c^2 s^2 +  (η1L1 )s^2)/(t0^2 /A2L1^2)/.t0->2 (depth1/Sqrt[3.0276]);
A4avL2 =-2(  (η2L2)c^2-  (η3L2)c^2 s^2 +  (η1L2 )s^2)/(t0^2 /A2L2^2)/.t0->2 (depth2/Sqrt[3.7636]);
A4avL3 =-2(  (η2L3)c^2-  (η3L3)c^2 s^2 +  (η1L3 )s^2)/(t0^2 /A2L3^2)/.t0->2 (depth3/Sqrt[7.5625]);
Q4av =((vert.{1/A2L1,1/A2L2,1/A2L3})^2-vertt (vert.{1/A2L1^2,1/A2L2^2,1/A2L3^2}))/(4 (vert.{1/A2L1,1/A2L2,1/A2L3})^4)+(vertt((vert^3).{A4avL1/ A2L1^4,A4avL2 /A2L2^4,A4avL3/ A2L3^4}))/(vert.{1/A2L1,1/A2L2,1/A2L3})^4;
xuplot = ParametricPlot[{theta*180/Pi,100Abs[Q4av/exact-1]},{theta,0,Pi/2},PlotRange->{All,All},PlotStyle->{Thick,RGBColor[1,0,0]},AspectRatio->0.5]


%Effect of acoustic approximation alone
A11L1 = 1/(c33(1+2δ2L1))/.c33->3.0276;
A11L2 =1/(c33(1+2δ2L2))/.c33->3.7636;
A11L3 =1/(c33(1+2δ2L3))/.c33->7.5625;
A22L1 = 1/(c33(1+2δ1L1))/.c33->3.0276;
A22L2 =1/(c33(1+2δ1L2))/.c33->3.7636;
A22L3 =1/(c33(1+2δ1L3))/.c33->7.5625;
A1111acousL1 =  (((-2η2L1) (1/(c33(1+2δ2L1)))^2)/t0^2 )/.c33->3.0276/.t0->2 (depth1/Sqrt[3.0276]);
A1111acousL2 =  (((-2η2L2) (1/(c33(1+2δ2L2)))^2)/t0^2 )/.c33->3.7636/.t0->2 (depth2/Sqrt[3.7636]);
A1111acousL3 =  (((-2η2L3) (1/(c33(1+2δ2L3)))^2)/t0^2 )/.c33->7.5625/.t0->2 (depth3/Sqrt[7.5625]);
A1122acousL1 =  ((-2ηxyL1) (1/(c33(1+2δ2L1))) (1/(c33(1+2δ1L1)))/t0^2 )/.c33->3.0276/.t0->2 (depth1/Sqrt[3.0276]);
A1122acousL2 =  ((-2ηxyL2) (1/(c33(1+2δ2L2))) (1/(c33(1+2δ1L2)))/t0^2 )/.c33->3.7636/.t0->2 (depth2/Sqrt[3.7636]);
A1122acousL3 =  ((-2ηxyL3) (1/(c33(1+2δ2L3))) (1/(c33(1+2δ1L3)))/t0^2 )/.c33->7.5625/.t0->2 (depth3/Sqrt[7.5625]);
A2222acousL1 =  ( (-2η1L1 ) (1/(c33(1+2δ1L1)))^2)/t0^2 /.c33->3.0276/.t0->2 (depth1/Sqrt[3.0276]);
A2222acousL2 =  ((-2η1L2 ) (1/(c33(1+2δ1L2)))^2)/t0^2 /.c33->3.7636/.t0->2 (depth2/Sqrt[3.7636]);
A2222acousL3 =  ((-2η1L3 ) (1/(c33(1+2δ1L3)))^2)/t0^2 /.c33->7.5625/.t0->2 (depth3/Sqrt[7.5625]);
vertow = vert/2;
verttow = vertt/2;
phi20 =-vertow.{1/A11L1,1/A11L2,1/A11L3};
phi02 =-vertow.{1/A22L1,1/A22L2,1/A22L3};
phi40 = (A1111acousL1 -1/(16(-vertow[[1]]/A11L1)^2))(48/vertow[[1]](-vertow[[1]]/A11L1)^4)  +  (A1111acousL2 -1/(16(-vertow[[2]]/A11L2)^2))(48/vertow[[2]](-vertow[[2]]/A11L2)^4)   +  (A1111acousL3 -1/(16(-vertow[[3]]/A11L3)^2))(48/vertow[[3]](-vertow[[3]]/A11L3)^4);
phi22 = (8 A1122acousL1-1/( -vertow[[1]]/A11L1 *-vertow[[1]]/A22L1 ))(vertow[[1]]/A11L1)^2 (-vertow[[1]]/A22L1 )^2/vertow[[1]]  +  (8 A1122acousL2-1/( -vertow[[2]]/A11L2 *-vertow[[2]]/A22L2 ))(vertow[[2]]/A11L2)^2 (-vertow[[2]]/A22L2 )^2/vertow[[2]]  +  (8 A1122acousL3-1/( -vertow[[3]]/A11L3 *-vertow[[3]]/A22L3 ))(vertow[[3]]/A11L3)^2 (-vertow[[3]]/A22L3 )^2/vertow[[3]];
phi04 = (A2222acousL1 -1/(16(-vertow[[1]]/A22L1)^2))(48/vertow[[1]](-vertow[[1]]/A22L1)^4)  +  (A2222acousL2 -1/(16(-vertow[[2]]/A22L2)^2))(48/vertow[[2]](-vertow[[2]]/A22L2)^4)   +  (A2222acousL3 -1/(16(-vertow[[3]]/A22L3)^2))(48/vertow[[3]](-vertow[[3]]/A22L3)^4);
A1111eff =1/(16 phi20^2) + verttow/(48 phi20^4)(phi40); 
A1122eff =1/(8phi20 phi02) + verttow/(8 phi20^2 phi02^2)(phi22); 
A2222eff =1/(16 phi02^2) + verttow/(48 phi02^4)(phi04); 
acous = A1111eff x1^4 + A1122eff x1^2 x2^2 + A2222eff x2^4/.{x1->c,x2->s }
acousplot = ParametricPlot[{theta*180/Pi,100Abs[acous/exact-1]},{theta,0,Pi/2},PlotRange->{All,All},PlotStyle->{Thick,Dashing[Large],RGBColor[0,0,1]},AspectRatio->0.5]
(-0.00671976-2.96567*10^-19 I) Cos[theta]^4-(0.0161938 +1.21078*10^-18 I) Cos[theta]^2 Sin[theta]^2-(0.00938985 +7.27466*10^-19 I) Sin[theta]^4

errorweak =Rasterize[Show[{alplot,xuplot,acousplot},LabelStyle->{FontWeight->"Bold",FontSize->22},Frame->True,FrameLabel->{"Azimuth","Relative Error (%)"},FrameStyle->Directive[Black,Thick], ImageSize->600,AspectRatio->0.7]]


Export["junk_ma.eps",errorweak,"EPS"]
